#!/bin/sh
CODEPATH="${HOME}/code"
LINKSDIR="${HOME}/c"
. "${HOME}/.csyncrc"
sync_code () {
	SOURCE="$(echo "${1}" | cut -d "/" -f 1)"
	SPATH="$(echo "${1}" | cut -d "/" -f 2-200)"
	shift
	REMOTE=$1
	shift
	DESTPATH=$1
	shift
	case "${SOURCE}" in
		github)
			if [ "${REMOTE}" == "upstream" ] ; then
				SOURCEREPO="https://github.com/${SPATH}"
			else
				SOURCEREPO="git@github.com:${SPATH}"
			fi
			;;
		bitbucket)
			SOURCEREPO="git@bitbucket.org:${SPATH}.git"
			;;
		gitlab)
			SOURCEREPO="git@gitlab.com:${SPATH}.git"
			;;
	esac
	if [ -d "${DESTPATH}" ] ; then
		cd ${DESTPATH}
		git remote add "${REMOTE}" "${SOURCEREPO}" 2>/dev/null >/dev/null
		git remote set-url "${REMOTE}" "${SOURCEREPO}"
		git fetch "${REMOTE}" &
	else
		git clone "${SOURCEREPO}" "${DESTPATH}"
	fi
	if [ "${USERPROFILE}" != "" ] ; then
		git config user.name "${name}"
		git config user.email "$(eval echo "\${${USERPROFILE}}")"
	fi
}
mkdir -p "${LINKSDIR}"
for spec in $(cat "${HOME}/.csync" ${HOME}/.csync.d/*)
do
	ORIGIN="$(echo "${spec}" | cut -d '|' -f 1)"
	UPSTREAM="$(echo "${spec}" | cut -sd '|' -f 2)"
	export USERPROFILE="$(echo "${spec}" | cut -sd '|' -f 3)"
	export BRANCH=""
	SOURCE="$(echo "${ORIGIN}" | cut -d "/" -f 1)"
	SPATH="$(echo "${ORIGIN}" | cut -d "/" -f 2-200)"
	DESTDIR="$(dirname "${SPATH}")"


	mkdir -p "${CODEPATH}/${SOURCE}/${DESTDIR}"
	sync_code "${ORIGIN}" origin "${CODEPATH}/${ORIGIN}"
	if [ "${UPSTREAM}" != "" ] ; then
		sync_code "${UPSTREAM}" upstream "${CODEPATH}/${ORIGIN}"
	fi
	NAME="$(basename "${ORIGIN}")"
	ln -fns "${CODEPATH}/${ORIGIN}" "${LINKSDIR}/${NAME}"

done
