#!/bin/sh
CODEPATH="${HOME}/code"
LINKSDIR="${HOME}/c"
sync_code () {
	SOURCE="$(echo "${1}" | cut -d "/" -f 1)"
	SPATH="$(echo "${1}" | cut -d "/" -f 2-200)"
	echo "${SPATH}"
	shift
	REMOTE=$1
	shift
	DESTPATH=$1
	shift
	BRANCH=$1
	case "${SOURCE}" in
		github)
			SOURCEREPO="git@github.com:${SPATH}"
			if [ -d "${DESTPATH}" ] ; then
				cd ${DESTPATH}
				git remote add "${REMOTE}" "${SOURCEREPO}" 2>/dev/null >/dev/null
				git remote set-url "${REMOTE}" "${SOURCEREPO}"
				git fetch "${REMOTE}" &
			else
				git clone "${SOURCEREPO}" "${DESTPATH}"
			fi
		;;
		bitbucket)
			SOURCEREPO="git@bitbucket.org:${SPATH}.git"
			if [ -d "${DESTPATH}" ] ; then
				cd ${DESTPATH}
				git fetch "${REMOTE}" &
			else
				git clone "${SOURCEREPO}" "${DESTPATH}"
			fi
		;;
	esac

}
mkdir -p "${LINKSDIR}"
for spec in $(cat "${HOME}/.csync" ${HOME}/.csync.d/*)
do
	ORIGIN="$(echo "${spec}" | cut -d '|' -f 1)"
	BRANCH="$(echo "${spec}" | cut -sd '|' -f 2)"
	UPSTREAM="$(echo "${spec}" | cut -sd '|' -f 3)"
	SOURCE="$(echo "${ORIGIN}" | cut -d "/" -f 1)"
	SPATH="$(echo "${ORIGIN}" | cut -d "/" -f 2-200)"
	DESTDIR="$(dirname "${SPATH}")"


	mkdir -p "${CODEPATH}/${SOURCE}/${DESTDIR}"
	sync_code "${ORIGIN}" origin "${CODEPATH}/${ORIGIN}" "${BRANCH}"
	if [ "${UPSTREAM}" != "" ] ; then
		sync_code "${UPSTREAM}" upstream "${CODEPATH}/${ORIGIN}" "${BRANCH}"
	fi
	NAME="$(basename "${ORIGIN}")"
	ln -s "${CODEPATH}/${ORIGIN}" "${LINKSDIR}/${NAME}"

done
